<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=google-site-verification content="<google-site-verification-code>"><meta name=author content="남규진"><meta name=description content="남규진의 개발 블로그"><meta name=keywords content="java,spring framework"><meta name=referrer content="always"><title>Github Scientist 로 두 시스템 응답 비교하기 - namkyujin.com</title><link rel=stylesheet type=text/css href=/css/main.css><link rel=icon href=/logo/favicon.ico type=image/x-icon></head><body><header><div><h1><a href=https://iamkyu.github.io>namkyujin.com</a></h1></div><nav><a href=/>blog</a><a href=https://github.com/iamkyu/TIL/blob/master/books/books.md>books</a><a href=/about/>about</a></nav></header><main><article><div class=meta><div>2024-01-03</div></div><div class=content><h1 id=github-scientist-로-두-시스템-응답-비교하기>Github Scientist 로 두 시스템 응답 비교하기</h1><p>같은 코드 베이스에서 상호작용하던 코드 일부를 물리적으로 분리 된 시스템, 새로운 프로그래밍 언어로 이식하는 과정에서 기존 코드와 신규 코드 동작의 일치 여부 검증이 필요했다.</p><p>조회성 유스케이스의 구현 코드들이었고 동작을 여러번 수행해도 결과가 달라지지 않았기에 병행 실행 후 두 결과를 비교하는 것이 안전하다 판단했다.
두 시스템을 (1) 병행 실행 (2) 결과를 비교 (3) 결과를 보고 하는 일련의 과정의 보일러 플레이트 코드를 줄이기 위한 실용적인 방법을 고민하던 중 <a href="https://search.shopping.naver.com/book/catalog/32485088006?cat_id=50010921&frm=PBOKPRO&query=%EB%A7%88%EC%9D%B4%ED%81%AC%EB%A1%9C%EC%84%9C%EB%B9%84%EC%8A%A4+%EB%8F%84%EC%9E%85%2C+%EC%9D%B4%EB%A0%87%EA%B2%8C+%ED%95%9C%EB%8B%A4&NaPm=ct%3Dlqx6b7co%7Cci%3D4a5f92a3a4069ea32790815ec27ec1f9b59b50f6%7Ctr%3Dboknx%7Csn%3D95694%7Chk%3Dbc572c04ec637074e2975abede999d09a3a0df47">“마이크로서비스 도입, 이렇게 한다(샘 뉴먼 저)”</a> 책에서 병행실행 패턴을 구현한 <a href=https://github.com/github/scientist>Github Scientist</a> 라이브러리를 알게 됐다.</p><blockquote><p>A Ruby library for carefully refactoring critical paths.</p></blockquote><p>루비 코드로 작성된 라이브러리 지만 이미 다양한 기여자가 PHP, 닷넷, 파이썬, 자바 등으로 이식한 버전이 있었고 내가 필요했던 자바 버전의 선택지는 두가지였다.</p><ul><li><a href=https://github.com/rawls238/Scientist4J>https://github.com/rawls238/Scientist4J</a></li><li><a href=https://github.com/MisterSpex/misterspex-scientist>https://github.com/MisterSpex/misterspex-scientist</a></li></ul><p><code>rawls238/Scientist4J</code> 버전이 Micrometer 와 같은 매트릭 수집 도구와 연동도 잘 된 편이지만 이는 불 필요했기에 의존성이 최소화 된 <code>MisterSpex/misterspex-scientist</code> 를 채택했지만 두 버전 모두 기본적인 구조는 유사하다.</p><ol><li><code>Experiment</code> 라는 실험을 만들고</li><li>1번에서 만든 실험 내에서 각 시스템의 호출을 수행. 결과를 <code>Observation</code> 에 담는다.</li><li>두 <code>Observation</code> 를 담은 <code>Result</code> 를 만든다.</li></ol><p>그리고 <code>Experiment</code> 에는 비어 있는 <code>publish(Result result)</code> 를 제공하는데 여기에 원하는 방식으로 <code>Result</code> 의 비교, 결과 수집을 구현 하면 된다.</p><p>비교 구현은 자바의 <code>equals</code> 구현을 검토했지만 <a href=https://bugs.openjdk.org/browse/JDK-8031085>JDK-8031085</a> 과 같은 버그로 한 시스템에서만 보정을 수행하여 차이가 발생했다. 이 차이는 중요하지 않은 유스케이스였지만 이런 각각의 엣지케이스에 대응하는 <code>equals</code> 를 구현하는게 합당해보이지 않았고 기존 코드 변경을 최소화 하고 싶었기에 모든 비교 대상에 <code>equals</code> 구현도 부담스러웠다.</p><p>대안으로 구글 Gson 을 통해 객체를 Json Tree 로 변환 후 재귀적으로 순회하며 <code>Map</code> 에 담아 비교하는 방식을 택했다. Tree 순회 구현은 ChatGPT 의 도움을 받았는데 신선한 경험이었다.
이 방식의 장점 중 하나는 객체의 속성 중 차이가 있는 속성명 수집이 쉬웠고, 이를 통해 속성명에 따라 다른 방식으로 비교 할 수 있는 점이다. 예컨대 앞서 말한 JDK 버그의 경우 속성명이 <code>at</code> 으로 끝나는 값은 초 까지만 비교하는 것이다.
비교 수행 후 값이 다른 속성에 한해 Kibana 에 수집하여 결과 차이를 쉽게 파악할 수 있기도 했다.</p><p>조회성 유스케이스에서 병행 실행 패턴은 적절하게 선택이었지만 변경을 유발하는 유스케이스에는 맞지 않았다. 다행히 복잡하지 않고 명령이 많은 시스템으로 전달되지 않았기에 회귀 테스트로도 많은 품이 들진 않았지만 좀 더 효율적인 방법을 고민하고 있다.</p></div><div class=side style=position:fixed;right:50px;max-width:255px;overflow:auto;top:120px;width:220px;bottom:90px><div class=toc><div class=page-header><strong>Table of contents</strong></div><div id=page-scrollspy class=toc-nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#github-scientist-%eb%a1%9c-%eb%91%90-%ec%8b%9c%ec%8a%a4%ed%85%9c-%ec%9d%91%eb%8b%b5-%eb%b9%84%ea%b5%90%ed%95%98%ea%b8%b0>Github Scientist 로 두 시스템 응답 비교하기</a></li></ul></div></div></div></article></main><footer><div><div>&copy; 2024 Kyujin Nam. <a href=https://creativecommons.org/licenses/by/4.0/deed.ko>CC-BY-4.0</a><p>Powered by <a href=https://gohugo.io/>Hugo</a> with <a href=https://github.com/yanlinlin82/simple-style>Simple-Style</a></div></div></footer><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-87267111-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><a href=https://github.com/iamkyu/iamkyu.github.io class=github-corner aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media(max-width:800px){.github-corner{display:none}}</style></body></html>